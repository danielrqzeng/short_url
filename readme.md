# 短域名服务

## 服务提供(api)
* [编码]()：为用户提供的长连接，编码成短链接
* [短语编码]()：为用户提供的长连接和短语，编码成短链接（根据用户的短语），管理员才有资格调用，有可能会失败，比如在禁用短语库中，已经被用掉了等等原因
* [解码]()：对于用户的短链接，重定向(302)到用户的原始链接
* [禁用]()：禁用某个短链接，这个只有管理员有资格调用

## 原理实现
### 概念
* **自增id**：本系统使用的是自增id来对应原始链接，id会单调递增（不保证连续），其从56800235583开始递增，56800235583对应的是62进制的100000
* **显示id**：由于自增id不能显示给外部，是以需要做一下[完美整数映射](https://github.com/RQZeng/num-shuffle)，以免暴露自增id给外部
* **短码**：是对显示id的一个b62编码（即其62进制）
* **短语**：用户自己想要用短语和原始链接对应起来(实际上程序中和短码是一样的，只不过概念上这个是用户侧的短码，由用户赋予了意义)
* **禁用短码库**：一些短码不能被使用，比如`fuck`这些词和延伸词，需要排除掉
* **待用短码库**：保留这些短码，给短语编码api使用，这个待用短码库是由英文词典（牛津国际英语词典第八版），中文字典（新华字典第第十二版）还有些自定义短码（比如年份）使用正则匹配组成
### 逻辑流程图
![H3ERN.jpg](https://img.ams1.imgbed.xyz/2021/05/18/H3ERN.jpg)
---
### 关键逻辑说明
#### 自增id和短码的关系
为了使得每个原始链接都能对应得上短链接，此处采用了自增id来一一对应起来，这里会有些问题
* 自增id若是暴露外部，则可能被爬虫暴力干死
* 自增id也有可能暴露业务，被人看穿

为了隐藏自增id，此处使用了[完美整数映射](https://github.com/RQZeng/num-shuffle)来对自增id进行指定范围内的整数shuffle，这样有几个好处
* 编码和解码纯通过算法来做，保证了性能（不用存db）
* 可以在任意范围内的整数做shuffle，并且在密钥不知道的情况下，无法看穿shuffle规律
* 短码可以保证在某一段范围内，比如短链接需要只有6位号码，那么就从指定的6位62进制数开始即可

#### 短语库
* 在插入db时候，已经插入了短语的数据，对应两个sql文件,`sql/avaiable_phrase_data.sql`和`sql/forbid_phrase_data.sql`
* 短语禁用库
    * `sql/phrase_data/forbid/phrase`:短语形式的原始词库
    * `sql/phrase_data/forbid/regexp`:正则形式的原始词库
* 短语待用库
    * `sql/phrase_data/available/phrase`:短语形式的原始词库
    * `sql/phrase_data/available/regexp`:正则形式的原始词库
* 重新生成短语库
    * `cd sql/phrase_data`
    * `python run_me_to_gen_sql.py`
        > 对于短语形式的词库，一律做成`.*w1.*w2.*w3.*`这种形式的正则匹配
        > 对于正则形式的词库，直接加入到数据中
        > 正则式会做提炼，比如两个正则是`.*ab.*`,和`.*abc.*`，会被提炼成只有`.*a.*
        > 将数据生成sql
    * `cd sql`;`sh run_me_to_build_scheme.sh`
#### 原始链接检测
原始链接有可能有很多不好的东西，比如涉黄，涉赌，此时需要有一定的机制来保证生态。
* 使用`安全联盟`提供的api，检测原始链接是不是合法的
* 目前没做黑白名单，缓存，重检，并且api比较耗时（150ms），是以也做了一个开关来可以随时开启关闭检测功能